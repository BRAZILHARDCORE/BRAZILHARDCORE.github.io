<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRAZIL_HARDCORE_EXE // TOXICITY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Chakra Petch', sans-serif;
            color: #e0e0e0;
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff00;
        }

        #hud-top {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .stat-box {
            text-transform: uppercase;
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-shadow: 0 0 5px #00ff00;
            font-weight: bold;
        }

        #timer-val {
            color: #ff0000;
            font-size: 2rem;
        }

        #drug-status {
            color: #ff00ff;
            font-size: 1.2rem;
            margin-top: 5px;
            text-shadow: 0 0 5px #ff00ff;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 100; /* Max Priority */
            text-align: center;
        }

        h1 {
            font-size: 4rem;
            margin: 0;
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00, 2px 2px 0px #ffff00;
            letter-spacing: -2px;
        }

        p {
            font-size: 1.2rem;
            max-width: 600px;
            line-height: 1.5;
            color: #aaa;
        }

        button {
            background: transparent;
            border: 2px solid #ffff00;
            color: #ffff00;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
            text-transform: uppercase;
            pointer-events: auto;
        }

        button:hover {
            background: #ffff00;
            color: #000;
            box-shadow: 0 0 20px #ffff00;
        }

        /* Scanlines */
        .scanlines {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 15;
            opacity: 0.6;
        }

        #shirt-unlock {
            display: none;
            background: #111;
            border: 2px solid #00ff00;
            padding: 20px;
            max-width: 400px;
            text-align: left;
        }
        
        .shirt-card {
            border: 1px solid #333;
            background: #000;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shirt-icon {
            width: 60px;
            height: 60px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        #toast {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            border: 1px solid #ff00ff;
            color: #ff00ff;
            padding: 10px 20px;
            font-size: 1.5rem;
            display: none;
            text-transform: uppercase;
            text-shadow: 0 0 10px #ff00ff;
            z-index: 50;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <!-- Gameplay HUD -->
    <div id="ui-layer">
        <div id="hud-top">
            <div class="stat-box">TIME: <span id="timer-val">30.00</span></div>
            <div style="text-align:right;">
                <div class="stat-box" id="status-msg">FIND THE SHIRT</div>
                <div id="drug-status">STATUS: SOBER</div>
            </div>
        </div>
        <div id="crosshair"></div>
        <div id="toast"></div>
    </div>

    <!-- Start/End Screens -->
    <div id="overlay">
        <h1 id="title-text">BRAZIL_HARDCORE</h1>
        <p id="desc-text">MISSION: LOCATE THE SHIRT VENDOR.<br>AVOID THE DRUG DEALERS.<br>WARNING: INTERACTION WITH DEALERS APPLIES CHEMICAL DEBUFFS.</p>
        
        <div id="shirt-unlock">
            <h2 style="color: #00ff00; margin-top:0;">> ITEM UNLOCKED</h2>
            <div class="shirt-card">
                <div class="shirt-icon">ðŸ‘•</div>
                <div>
                    <strong style="color: #ffff00; display:block;">THE BUTTER</strong>
                    <span style="font-size: 0.8rem; color: #888;">Neon Green / Glows in Dark. 100% Viscose.</span>
                </div>
            </div>
            <p style="font-size: 0.9rem; margin: 0;">Code: BZL-HC-2025-X</p>
        </div>

        <button id="start-btn">ENTER WAREHOUSE</button>
    </div>

    <!-- Three.js from Skypack for reliable imports -->
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.128.0';
        import { PointerLockControls } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/controls/PointerLockControls.js';

        // --- CONFIG ---
        const CONFIG = {
            baseSpeed: 40.0,
            lookSpeed: 2.0,
            dealersCount: 6,
            worldSize: 60,
            timeLimit: 30.0
        };

        // --- STATE ---
        let camera, scene, renderer, controls;
        let raycaster;
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let dealers = []; 
        let isGameActive = false;
        let walls = [];
        let dancers = [];
        let timeLeft = CONFIG.timeLimit;
        
        // DRUG STATE
        let activeDrug = null; // 'SLOW', 'FAST', 'DISTORT'
        let currentSpeed = CONFIG.baseSpeed;

        // --- ASSETS ---
        function createNeonTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 64, 64);
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, 64, 64);
            ctx.fillStyle = color;
            ctx.font = '10px monospace';
            ctx.fillText('B_HC', 10, 35);
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.magFilter = THREE.NearestFilter;
            return tex;
        }

        const texWall = createNeonTexture('#222');

        // --- INIT ---
        init();
        animate();

        function init() {
            const container = document.body;

            // SCENE
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.FogExp2(0x050505, 0.035);

            // CAMERA
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.y = 1.6;

            // LIGHTS
            const light = new THREE.HemisphereLight(0x111111, 0x000000, 0.6);
            scene.add(light);
            
            const danceLight = new THREE.PointLight(0x00ff00, 1, 30);
            danceLight.position.set(0, 5, 0);
            scene.add(danceLight);

            // RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // CONTROLS
            controls = new PointerLockControls(camera, document.body);

            // EVENT LISTENERS
            const startBtn = document.getElementById('start-btn');
            const overlay = document.getElementById('overlay');

            startBtn.addEventListener('click', () => {
                if (startBtn.innerText === "ENTER WAREHOUSE" || startBtn.innerText === "RETRY") {
                    resetGame();
                    overlay.style.display = 'none';
                    isGameActive = true;
                    try {
                        controls.lock();
                    } catch (e) {
                        console.warn("Pointer lock failed, playing anyway", e);
                    }
                } else {
                     window.location.reload(); 
                }
            });

            controls.addEventListener('lock', () => {
                isGameActive = true;
                overlay.style.display = 'none';
            });

            controls.addEventListener('unlock', () => {
                // If we unlock due to game over, fine. If user unlocks manually, we pause logic essentially.
                // We keep isGameActive true if it was just a manual unlock? No, pause it.
                // But timer keeps running in rave logic? No, let's pause.
                if (timeLeft > 0 && !document.getElementById('shirt-unlock').style.display.includes('block')) {
                    // Manual pause
                    isGameActive = false;
                    overlay.style.display = 'flex';
                }
            });

            // INPUT
            const onKeyDown = function (event) {
                switch (event.code) {
                    case 'ArrowUp':
                    case 'KeyW': moveForward = true; break;
                    case 'ArrowLeft':
                    case 'KeyA': moveLeft = true; break;
                    case 'ArrowDown':
                    case 'KeyS': moveBackward = true; break;
                    case 'ArrowRight':
                    case 'KeyD': moveRight = true; break;
                }
            };

            const onKeyUp = function (event) {
                switch (event.code) {
                    case 'ArrowUp':
                    case 'KeyW': moveForward = false; break;
                    case 'ArrowLeft':
                    case 'KeyA': moveLeft = false; break;
                    case 'ArrowDown':
                    case 'KeyS': moveBackward = false; break;
                    case 'ArrowRight':
                    case 'KeyD': moveRight = false; break;
                }
            };

            document.addEventListener('mousedown', () => {
                if (isGameActive) checkInteraction();
            });

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, 0, -1), 0, 5);

            buildLevel();
            window.addEventListener('resize', onWindowResize);
        }

        function buildLevel() {
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            floorGeo.rotateX(-Math.PI / 2);
            const floorMat = new THREE.MeshBasicMaterial({ color: 0x111111 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            scene.add(floor);
            
            const danceFloorGeo = new THREE.PlaneGeometry(30, 30);
            danceFloorGeo.rotateX(-Math.PI / 2);
            const danceFloorMat = new THREE.MeshBasicMaterial({ color: 0x222222 }); 
            const danceFloor = new THREE.Mesh(danceFloorGeo, danceFloorMat);
            danceFloor.position.y = 0.05;
            scene.add(danceFloor);

            const boxGeo = new THREE.BoxGeometry(4, 5, 4);
            const wallMat = new THREE.MeshLambertMaterial({ map: texWall });
            
            walls.forEach(w => scene.remove(w));
            walls = [];
            dealers.forEach(d => scene.remove(d.mesh));
            dealers = [];
            dancers.forEach(d => scene.remove(d.mesh));
            dancers = [];

            for (let i = 0; i < 40; i++) {
                const wall = new THREE.Mesh(boxGeo, wallMat);
                let x = (Math.random() - 0.5) * CONFIG.worldSize;
                let z = (Math.random() - 0.5) * CONFIG.worldSize;
                if (Math.abs(x) < 15 && Math.abs(z) < 15) {
                    if (x > 0) x += 15; else x -= 15;
                    if (z > 0) z += 15; else z -= 15;
                }
                wall.position.x = x;
                wall.position.y = 2.5;
                wall.position.z = z;
                scene.add(wall);
                walls.push(wall);
            }

            const dancerGeo = new THREE.BoxGeometry(0.5, 1.8, 0.5);
            for(let i=0; i<50; i++) {
                const color = Math.random() > 0.5 ? 0x00ff00 : 0xffff00; 
                const mat = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
                const mesh = new THREE.Mesh(dancerGeo, mat);
                const x = (Math.random() - 0.5) * 20; 
                const z = (Math.random() - 0.5) * 20;
                mesh.position.set(x, 0.9, z);
                scene.add(mesh);
                dancers.push({
                    mesh: mesh,
                    baseY: 0.9,
                    offset: Math.random() * Math.PI * 2,
                    speed: 5 + Math.random() * 5
                });
            }

            const dealerGeo = new THREE.CylinderGeometry(0.6, 0.6, 2.2, 8);
            for(let i=0; i < CONFIG.dealersCount; i++) {
                const mat = new THREE.MeshPhongMaterial({ 
                    color: 0x222222, 
                    emissive: 0x001100,
                    shininess: 100
                });

                const mesh = new THREE.Mesh(dealerGeo, mat);
                let x = (Math.random() - 0.5) * CONFIG.worldSize;
                let z = (Math.random() - 0.5) * CONFIG.worldSize;
                if(Math.abs(x) < 10 && Math.abs(z) < 10) x += 20;

                mesh.position.set(x, 1.1, z);
                
                const visorGeo = new THREE.BoxGeometry(0.4, 0.1, 0.2);
                const visorMat = new THREE.MeshBasicMaterial({ color: 0x555555 });
                const visor = new THREE.Mesh(visorGeo, visorMat);
                visor.position.set(0, 0.6, 0.5);
                mesh.add(visor);

                scene.add(mesh);

                dealers.push({
                    mesh: mesh,
                    isReal: false, 
                    visor: visor,
                    interacted: false
                });
            }

            let realIndex = Math.floor(Math.random() * dealers.length);
            dealers.forEach((d, idx) => {
                if(idx === realIndex) d.isReal = true;
            });
        }

        function checkInteraction() {
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(dealers.map(d => d.mesh));

            if (intersects.length > 0) {
                const hitObj = intersects[0].object;
                const dealerData = dealers.find(d => d.mesh === hitObj);
                if (dealerData && !dealerData.interacted) resolveInteraction(dealerData);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2500);
        }

        function applyDrug(type) {
            activeDrug = type;
            const statusDiv = document.getElementById('drug-status');
            statusDiv.style.opacity = 1;
            
            if (type === 'SLOW') {
                currentSpeed = 10.0;
                statusDiv.innerText = "STATUS: DOWNER (SLOW)";
                statusDiv.style.color = "#0000ff";
                showToast("TOOK A DOWNER... LEGS HEAVY...");
            } else if (type === 'FAST') {
                currentSpeed = 80.0; // Uncontrollable
                statusDiv.innerText = "STATUS: UPPER (SPEED)";
                statusDiv.style.color = "#ff0000";
                showToast("TOOK AN UPPER... TOO FAST...");
            } else if (type === 'DISTORT') {
                currentSpeed = CONFIG.baseSpeed;
                statusDiv.innerText = "STATUS: PSYCHEDELIC";
                statusDiv.style.color = "#ff00ff";
                showToast("BAD TRIP... REALITY BROKEN...");
            }
        }

        function resolveInteraction(dealer) {
            dealer.interacted = true;

            if (dealer.isReal) {
                // WIN
                controls.unlock();
                isGameActive = false;
                const overlay = document.getElementById('overlay');
                const title = document.getElementById('title-text');
                const desc = document.getElementById('desc-text');
                const btn = document.getElementById('start-btn');
                const shirtDiv = document.getElementById('shirt-unlock');
                
                overlay.style.display = 'flex';
                document.body.style.backgroundColor = '#00ff00';
                title.innerText = "SHIRT SECURED";
                title.style.color = "#00ff00";
                desc.innerHTML = "Authentic Brazil Hardcore obtained.<br>Escaped the rave alive.";
                desc.style.color = "#fff";
                shirtDiv.style.display = 'block';
                btn.innerText = "CLAIM & EXIT";
                dealer.visor.material.color.setHex(0x00ff00);
            } else {
                // DRUG PENALTY - DO NOT END GAME
                dealer.visor.material.color.setHex(0xff00ff); // Purple for drug dealer
                dealer.mesh.material.emissive.setHex(0x220022);
                
                // Random Drug
                const roll = Math.random();
                if (roll < 0.33) applyDrug('SLOW');
                else if (roll < 0.66) applyDrug('FAST');
                else applyDrug('DISTORT');
            }
        }

        function triggerTimeout() {
            controls.unlock();
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('title-text');
            const desc = document.getElementById('desc-text');
            const btn = document.getElementById('start-btn');
            const shirtDiv = document.getElementById('shirt-unlock');
            
            overlay.style.display = 'flex';
            document.body.style.backgroundColor = '#333';
            title.innerText = "TOO SLOW";
            title.style.color = "#888";
            desc.innerHTML = "THE DROP IS OVER.<br>YOU WALKED HOME EMPTY HANDED.";
            shirtDiv.style.display = 'none';
            btn.innerText = "RETRY";
        }

        function resetGame() {
            document.body.style.backgroundColor = '#050505';
            document.getElementById('shirt-unlock').style.display = 'none';
            document.getElementById('drug-status').style.opacity = 0;
            camera.position.set(0, 1.6, 25);
            camera.lookAt(0, 1.6, 0);
            camera.fov = 75;
            camera.updateProjectionMatrix();
            velocity.set(0, 0, 0);
            timeLeft = CONFIG.timeLimit;
            document.getElementById('timer-val').innerText = timeLeft.toFixed(2);
            activeDrug = null;
            currentSpeed = CONFIG.baseSpeed;
            buildLevel();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isGameActive) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000;
                
                timeLeft -= delta;
                if(timeLeft <= 0) {
                    timeLeft = 0;
                    triggerTimeout();
                    isGameActive = false;
                }
                document.getElementById('timer-val').innerText = timeLeft.toFixed(2);

                // MOVEMENT
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * currentSpeed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * currentSpeed * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // DRUG VISUAL EFFECTS
                if (activeDrug === 'DISTORT') {
                    // FOV oscillation
                    camera.fov = 75 + Math.sin(time * 0.005) * 40;
                    camera.updateProjectionMatrix();
                    // Slight color shift in background
                    const hue = (Math.sin(time * 0.001) + 1) * 0.5;
                    scene.background.setHSL(hue, 0.5, 0.05);
                } else {
                    // Standard Strobe
                    if (Math.random() > 0.95) {
                        scene.background.setHex(Math.random() > 0.5 ? 0x111111 : 0x000000);
                    }
                }
                
                const t = time * 0.005;
                dancers.forEach(d => {
                    d.mesh.position.y = d.baseY + Math.abs(Math.sin(t * d.speed + d.offset)) * 0.5;
                    d.mesh.rotation.y += delta * 2;
                });
                
                dealers.forEach(d => {
                    d.mesh.rotation.y += delta * 0.5;
                });

                prevTime = time;
            } else {
                prevTime = performance.now();
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
